server {
    listen 80;
    server_name localhost;

    location / {
        # 캐시 설정
        proxy_cache my_cache;
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404 1m;
        proxy_cache_key $scheme$proxy_host$request_uri;

        # 캐시 상태를 응답 헤더에 추가 (HIT/MISS/EXPIRED 등)
        add_header X-Cache-Status $upstream_cache_status always;
        add_header X-Cache-Key $scheme$proxy_host$request_uri always;

        # Origin 서버로 프록시
        proxy_pass http://origin:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Lab 2: Origin의 Cache-Control을 존중하는 location
    location /api/short-ttl {
        proxy_cache my_cache;
        proxy_cache_valid 200 10m;  # Nginx 기본 TTL: 10분
        # 하지만 Origin이 Cache-Control: max-age=5를 보내면?
        proxy_cache_key $scheme$proxy_host$request_uri;

        add_header X-Cache-Status $upstream_cache_status always;
        proxy_pass http://origin:3000;
    }

    # Lab 2: no-store 응답 처리
    location /api/no-cache {
        proxy_cache my_cache;
        proxy_cache_valid 200 10m;
        proxy_cache_key $scheme$proxy_host$request_uri;

        add_header X-Cache-Status $upstream_cache_status always;
        proxy_pass http://origin:3000;
    }

    # 헬스체크 (캐시 안 함)
    location /health {
        proxy_pass http://origin:3000;
        proxy_cache off;
    }
}
