server {
    listen 80;
    server_name localhost;

    location / {
        # 캐시 설정
        proxy_cache my_cache;
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404 1m;
        proxy_cache_key $scheme$proxy_host$request_uri;

        # 캐시 상태를 응답 헤더에 추가 (HIT/MISS/EXPIRED 등)
        add_header X-Cache-Status $upstream_cache_status always;
        add_header X-Cache-Key $scheme$proxy_host$request_uri always;

        # Origin 서버로 프록시
        proxy_pass http://origin:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Lab 3: utm 파라미터를 제거한 캐시 키
    location /api/products {
        proxy_cache my_cache;
        proxy_cache_valid 200 10m;

        # utm_ 파라미터를 제거한 clean args 생성
        set $clean_args $args;
        if ($clean_args ~ (.*)(?:&|^)utm_[a-z]+=(?:[^&]*)&?(.*)) {
            set $clean_args $1$2;
        }

        # 캐시 키: URI + 정제된 쿼리스트링
        proxy_cache_key $scheme$proxy_host$uri$is_args$clean_args;

        add_header X-Cache-Status $upstream_cache_status always;
        add_header X-Cache-Key $scheme$proxy_host$uri$is_args$clean_args always;
        proxy_pass http://origin:3000;
    }

    # Lab 3: 커스텀 헤더를 캐시 키에 포함
    location /api/profile {
        proxy_cache my_cache;
        proxy_cache_valid 200 10m;
        # X-User-Id 헤더를 캐시 키에 포함 → 사용자별 캐시
        proxy_cache_key $scheme$proxy_host$request_uri$http_x_user_id;

        add_header X-Cache-Status $upstream_cache_status always;
        add_header X-Cache-Key $scheme$proxy_host$request_uri$http_x_user_id always;
        proxy_pass http://origin:3000;
        proxy_set_header X-User-Id $http_x_user_id;
    }

    # Lab 2: Origin의 Cache-Control을 존중하는 location
    location /api/short-ttl {
        proxy_cache my_cache;
        proxy_cache_valid 200 10m;  # Nginx 기본 TTL: 10분
        # 하지만 Origin이 Cache-Control: max-age=5를 보내면?
        proxy_cache_key $scheme$proxy_host$request_uri;

        add_header X-Cache-Status $upstream_cache_status always;
        proxy_pass http://origin:3000;
    }

    # Lab 2: no-store 응답 처리
    location /api/no-cache {
        proxy_cache my_cache;
        proxy_cache_valid 200 10m;
        proxy_cache_key $scheme$proxy_host$request_uri;

        add_header X-Cache-Status $upstream_cache_status always;
        proxy_pass http://origin:3000;
    }

    # 헬스체크 (캐시 안 함)
    location /health {
        proxy_pass http://origin:3000;
        proxy_cache off;
    }
}
